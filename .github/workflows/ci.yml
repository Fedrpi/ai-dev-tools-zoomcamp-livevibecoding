name: CI Pipeline

on:
  push:
    branches: [ main, init, develop ]
  pull_request:
    branches: [ main, init, develop ]

jobs:
  # Security: Check for secrets and sensitive data
  secrets-scan:
    name: Scan for Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better detection

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Lint Backend (Python)
  lint-backend:
    name: Lint Backend (Python)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Run Ruff (linter)
        run: |
          cd backend
          uv run ruff check .

      - name: Run Ruff (formatter check)
        run: |
          cd backend
          uv run ruff format --check .

      - name: Run MyPy (type checker)
        run: |
          cd backend
          uv run mypy app --ignore-missing-imports
        continue-on-error: true  # Don't fail build on type errors yet

  # Lint Frontend (JavaScript/Vue)
  lint-frontend:
    name: Lint Frontend (Vue.js)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run ESLint
        run: |
          cd frontend
          npm run lint
        continue-on-error: true  # Don't fail if no eslint configured

  # Test Backend
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    needs: [secrets-scan, lint-backend]

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: livecoding
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: livecoding_test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install UV
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          cd backend
          uv sync

      - name: Run tests
        env:
          TEST_DATABASE_URL: postgresql+asyncpg://livecoding:test_password@localhost:5432/livecoding_test_db
        run: |
          cd backend
          uv run pytest -v --tb=short
        # Note: Tests use conftest.py fixtures that create/drop tables automatically
        # No need to run migrations here - conftest.py handles schema creation

  # Test Frontend
  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    needs: [secrets-scan, lint-frontend]

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: |
          cd frontend
          npm ci

      - name: Run tests
        run: |
          cd frontend
          npm test -- --run

  # Build Docker Images (verification)
  build-docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [test-backend, test-frontend]

    strategy:
      matrix:
        service: [backend, frontend]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build ${{ matrix.service }}
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          file: ./${{ matrix.service }}/Dockerfile
          push: false
          tags: livecoding-${{ matrix.service }}:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # Summary job
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [secrets-scan, lint-backend, lint-frontend, test-backend, test-frontend, build-docker]
    if: success()

    steps:
      - name: Success message
        run: |
          echo "âœ… All CI checks passed!"
          echo "- Secrets scan: passed"
          echo "- Backend linting: passed"
          echo "- Frontend linting: passed"
          echo "- Backend tests: passed"
          echo "- Frontend tests: passed"
          echo "- Docker builds: passed"
