name: Deploy to Yandex Cloud

on:
  workflow_dispatch:  # Manual deployment only
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
  push:
    branches:
      - main  # Auto-deploy on push to main

jobs:
  deploy:
    name: Deploy to Yandex Cloud (${{ inputs.environment || 'production' }})
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.YC_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.YC_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to Yandex Cloud
        env:
          SERVER_IP: ${{ secrets.YC_SERVER_IP }}
          SERVER_USER: ${{ secrets.YC_SERVER_USER }}
        run: |
          echo "ðŸš€ Deploying to Yandex Cloud..."

          # Deploy via SSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'ENDSSH'
            set -e

            # Navigate to project directory
            cd /home/ubuntu/livevibecoding || {
              echo "Error: Project directory not found"
              exit 1
            }

            # Run deployment script
            ./deploy.sh
          ENDSSH

          echo "âœ… Deployment completed successfully!"

      - name: Verify Deployment
        env:
          SERVER_IP: ${{ secrets.YC_SERVER_IP }}
        run: |
          echo "ðŸ” Verifying deployment..."
          sleep 10

          # Check health endpoint
          if curl -f http://${SERVER_IP}/api/health; then
            echo "âœ… Application is healthy!"
          else
            echo "âš ï¸  Health check warning - application might still be starting"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Deployment Summary
        if: success()
        run: |
          echo "========================================="
          echo "ðŸŽ‰ Deployment Successful!"
          echo "========================================="
          echo "Environment: ${{ inputs.environment || 'production' }}"
          echo "Server: ${{ secrets.YC_SERVER_IP }}"
          echo "Application URL: http://${{ secrets.YC_SERVER_IP }}"
          echo "API Docs: http://${{ secrets.YC_SERVER_IP }}/api/docs"
          echo "========================================="
