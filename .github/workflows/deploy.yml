name: Deploy to Yandex Cloud

on:
  workflow_run:
    workflows: ["Build and Push Docker Images"]
    types:
      - completed
    branches: [ main ]
  workflow_dispatch:  # Manual deployment only
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  deploy:
    name: Deploy to Yandex Cloud (${{ inputs.environment || 'production' }})
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name != 'workflow_run' }}
    environment: ${{ inputs.environment || 'production' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.YC_SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.YC_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to Yandex Cloud
        env:
          SERVER_IP: ${{ secrets.YC_SERVER_IP }}
          SERVER_USER: ${{ secrets.YC_SERVER_USER }}
        run: |
          echo "üöÄ Deploying to Yandex Cloud..."

          # Deploy via SSH
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SERVER_USER}@${SERVER_IP} << 'ENDSSH'
            set -e

            # Run deployment script (uses $HOME variable for paths)
            ${HOME}/ai-dev-tools-zoomcamp-livevibecoding/deploy.sh
          ENDSSH

          echo "‚úÖ Deployment completed successfully!"

      - name: Verify Deployment
        env:
          SERVER_IP: ${{ secrets.YC_SERVER_IP }}
        run: |
          echo "üîç Verifying deployment..."
          sleep 10

          # Check if frontend is accessible
          if curl -f http://${SERVER_IP}/ > /dev/null 2>&1; then
            echo "‚úÖ Application is healthy!"
          else
            echo "‚ö†Ô∏è  Health check warning - application might still be starting"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Deployment Summary
        if: success()
        run: |
          echo "========================================="
          echo "üéâ Deployment Successful!"
          echo "========================================="
          echo "Environment: ${{ inputs.environment || 'production' }}"
          echo "Server: ${{ secrets.YC_SERVER_IP }}"
          echo "Application URL: http://${{ secrets.YC_SERVER_IP }}"
          echo "API Docs: http://${{ secrets.YC_SERVER_IP }}/api/docs"
          echo "========================================="
